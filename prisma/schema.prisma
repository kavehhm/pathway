generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model Availability {
  id        String    @id @default(uuid())
  visible   Boolean
  userId    String
  day       String
  available Boolean
  timeRange String?   @db.VarChar(255)
  endTime   DateTime?
  startTime DateTime?
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model User {
  id                       String         @id @default(uuid())
  username                 String         @unique @default(cuid())
  email                    String         @default("None")
  bio                      String         @default("None")
  clerkId                  String         @unique
  school                   String         @default("None")
  major                    String         @default("None")
  approved                 Boolean        @default(false)
  description              String         @default("None")
  calendlyLink             String         @default("None")
  reviewPoints             Int            @default(0)
  gpa                      Float          @default(0.0)
  tutorInPerson            Boolean        @default(false)
  reviewQuantity           Int            @default(0)
  country                  String         @default("United States")
  state                    String         @default("California")
  zipCode                  Int            @default(0)
  firstName                String         @default("None")
  lastName                 String         @default("None")
  imageSrc                 String         @default("")
  subjects                 String[]
  hourlyRate               Int            @default(0)
  meetingLink              String?
  timezone                 String         @default("PST")
  stripeAccountId          String?
  stripeAccountStatus      String?
  // Expanded Stripe Connect fields for wallet + withdraw model
  stripeChargesEnabled     Boolean        @default(false)
  stripePayoutsEnabled     Boolean        @default(false)
  stripeRequirements       Json?
  firstSessionFree         Boolean        @default(false)
  eduEmail                 String?        @db.VarChar(255)
  eduVerificationCode      String?        @db.VarChar(10)
  eduVerificationExpiresAt DateTime?
  eduVerified              Boolean        @default(false)
  isTutor                  Boolean        @default(false)
  // Career / admissions experience tags (used for search)
  careerCompanies          String[]       @default([])
  careerIsInternship       Boolean        @default(true)
  isTransfer               Boolean        @default(false)
  availability             Availability[]
  bookings                 Booking[]      @relation("TutorBookings")
  tutoredCourses           TutorCourse[]  @relation("TutorToCourses")
  reviewsReceived          Review[]       @relation("TutorReviews")
  reviewsGiven             Review[]       @relation("StudentReviews")
  // Wallet relations
  wallet                   MentorWallet?
  ledgerEntries            MentorLedgerEntry[]
  payouts                  MentorPayout[]
}

// ============= MENTOR WALLET SYSTEM =============

model MentorWallet {
  id            String   @id @default(uuid())
  mentorId      String   @unique
  mentor        User     @relation(fields: [mentorId], references: [clerkId])
  // Available balance that can be withdrawn (in cents)
  availableCents Int     @default(0)
  // Pending balance (earnings from completed sessions not yet available for withdrawal)
  pendingCents   Int     @default(0)
  currency       String  @default("usd")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([mentorId])
}

enum LedgerEntryType {
  SESSION_EARNED       // Earnings credited from a completed session
  WITHDRAW_REQUESTED   // Withdraw request initiated
  TRANSFER_CREATED     // Stripe transfer successfully created
  TRANSFER_FAILED      // Stripe transfer failed
  ADJUSTMENT           // Manual adjustment (admin)
  PENDING_TO_AVAILABLE // Moved from pending to available balance
}

model MentorLedgerEntry {
  id                String          @id @default(uuid())
  mentorId          String
  mentor            User            @relation(fields: [mentorId], references: [clerkId])
  type              LedgerEntryType
  amountCents       Int             // Positive for credits, negative for debits
  balanceAfterCents Int?            // Snapshot of available balance after this entry
  relatedSessionId  String?         // Booking ID if related to a session
  relatedPayoutId   String?         // MentorPayout ID if related to a payout
  stripeTransferId  String?         // Stripe transfer ID if applicable
  stripePaymentIntentId String?     // Stripe PaymentIntent ID for session payments
  description       String?         // Human-readable description
  createdAt         DateTime        @default(now())

  @@index([mentorId])
  @@index([relatedSessionId])
  @@index([relatedPayoutId])
  @@index([createdAt])
}

enum PayoutStatus {
  INITIATED           // Payout request started
  REQUIRES_ONBOARDING // Mentor needs to complete Stripe onboarding
  PROCESSING          // Transfer is being processed
  PAID                // Successfully transferred
  FAILED              // Transfer failed
}

model MentorPayout {
  id               String       @id @default(uuid())
  mentorId         String
  mentor           User         @relation(fields: [mentorId], references: [clerkId])
  amountCents      Int          // Amount requested for withdrawal
  status           PayoutStatus @default(INITIATED)
  stripeTransferId String?      // Stripe transfer ID once created
  failureReason    String?      // Reason if transfer failed
  idempotencyKey   String       @unique // Prevent duplicate transfers
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@index([mentorId])
  @@index([status])
  @@index([createdAt])
}

model Booking {
  id                    String   @id @default(uuid())
  tutorId               String
  date                  DateTime
  time                  String
  status                String   @default("confirmed")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  free                  Boolean  @default(false)
  studentClerkId        String?
  // Payment tracking for wallet system
  stripePaymentIntentId String?  // Stripe PaymentIntent ID
  totalAmountCents      Int?     // Total amount charged to student (in cents)
  platformFeeCents      Int?     // Platform fee amount (in cents)
  mentorEarningsCents   Int?     // Amount mentor earns (total - platform fee)
  earningsProcessed     Boolean  @default(false) // Whether earnings have been added to wallet
  availableAt           DateTime? // When this booking's earnings become withdrawable
  fundsReleased         Boolean  @default(false) // Whether earnings moved from pending to available
  // Student info for calendar and emails
  studentEmail          String?  // Student's email for calendar invites
  studentName           String?  // Student's name
  // Tutor email captured at booking time
  tutorEmail            String?  // Tutor's email for calendar invites
  // Google Calendar integration
  calendarEventId       String?  // Google Calendar event ID
  meetLink              String?  // Google Meet link (or tutor's custom meeting link)
  calendarHtmlLink      String?  // Google Calendar event link for viewing
  // Tokenized booking actions for guest-safe flows
  tutorCancelTokenHash          String?
  tutorCancelTokenExpiresAt     DateTime?
  tutorCancelTokenUsedAt        DateTime?
  studentRescheduleTokenHash    String?
  studentRescheduleTokenExpiresAt DateTime?
  studentRescheduleTokenUsedAt  DateTime?
  studentRefundTokenHash        String?
  studentRefundTokenExpiresAt   DateTime?
  studentRefundTokenUsedAt      DateTime?
  // Cancellation/refund audit fields
  tutorCancelledAt      DateTime?
  refundedAt            DateTime?
  stripeRefundId        String?
  tutor                 User     @relation("TutorBookings", fields: [tutorId], references: [clerkId])
  review                Review?  @relation("BookingReview")

  @@unique([tutorId, date, time])
  @@index([tutorId])
  @@index([date])
  @@index([studentClerkId])
  @@index([stripePaymentIntentId])
  @@index([calendarEventId])
  @@index([tutorCancelTokenHash])
  @@index([studentRescheduleTokenHash])
  @@index([studentRefundTokenHash])
}

model Course {
  id         String        @id @default(uuid())
  courseId   String
  courseName String
  school     String
  createdAt  DateTime      @default(now())
  tutors     TutorCourse[] @relation("CourseTutors")

  @@unique([courseId, school])
  @@index([school])
  @@index([courseId])
}

model TutorCourse {
  id        String   @id @default(uuid())
  userId    String
  courseId  String
  createdAt DateTime @default(now())
  user      User     @relation("TutorToCourses", fields: [userId], references: [id])
  course    Course   @relation("CourseTutors", fields: [courseId], references: [id])

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Review {
  id             String   @id @default(uuid())
  bookingId      String   @unique
  tutorClerkId   String
  studentClerkId String
  rating         Float
  reviewText     String?
  tutorResponse  String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  booking        Booking  @relation("BookingReview", fields: [bookingId], references: [id])
  tutor          User     @relation("TutorReviews", fields: [tutorClerkId], references: [clerkId])
  student        User     @relation("StudentReviews", fields: [studentClerkId], references: [clerkId])

  @@index([bookingId])
  @@index([tutorClerkId])
  @@index([studentClerkId])
  @@index([rating])
  @@index([createdAt])
}
